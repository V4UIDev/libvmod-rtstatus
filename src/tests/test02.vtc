varnishtest "Primitive sanity check"

server s1 {
	rxreq
	txresp
} -start

varnish v1 -arg "-i ${tmpdir}/v1" -vcl+backend {
	import rtstatus from "${vmod_topbuild}/src/.libs/libvmod_rtstatus.so";

	sub vcl_recv {
		if (req.url == "/rtstatus.json") {
			return(synth(200));
		}
	}

	sub vcl_synth {
		if (req.url == "/rtstatus.json") {
			rtstatus.synthetic_json();
			return(deliver);
		}
	}
} -start

client c1 {
	txreq -url "/rtstatus.json"
	rxresp
	expect resp.status == 200
	expect resp.http.content-type ~ "application/json"
	expect resp.body ~ "MAIN.s_req"
	expect resp.body ~ {"uptime_sec": 0,}
} -run

delay 2

client c1 {
	txreq -url "/rtstatus.json"
	rxresp
	expect resp.status == 200
	expect resp.http.content-type ~ "application/json"
	expect resp.body ~ "MAIN.s_req"
	expect resp.body !~ {"uptime_sec": 0,}
} -run
